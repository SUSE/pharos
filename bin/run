#!/bin/bash

setup_root_ca() {
  # Velum is going to need this CA to talk to the running CaaSP Cluster
  [ -f "/etc/pki/trust/anchors/SUSE_CaaSP_CA.pem" ] && return

  cp /etc/pki/ca.crt /etc/pki/trust/anchors/SUSE_CaaSP_CA.pem
  update-ca-certificates
}

check_ldap() {
  set +e

  TIMEOUT=90
  COUNT=0
  RETRY=1

  while [ $RETRY -ne 0 ]; do
    case $(bundle exec rails r bin/check_ldap.rb | grep LDAP) in
      "LDAP_DOWN")
        if [ "$COUNT" -ge "$TIMEOUT" ]; then
          printf " [FAIL]\n"
          echo "Timeout reached, exiting with error"
          exit 1
        fi
        echo "Waiting for ldap to be ready in 5 seconds"
        sleep 5
        COUNT=$((COUNT+5))
        ;;
      *)
        echo "LDAP is ready"
        break
        ;;
    esac
  done
  set -e
}

setup_root_ca
check_ldap
bundle exec "puma -C config/puma.rb"
